// src/core/agent.pest

WHITESPACE = _{ " " | "\t" | "\r" | "\n" }
COMMENT = _{ "#" ~ (!NEWLINE ~ ANY)* ~ NEWLINE? }

// Values
string = @{ "\"" ~ (!"\"" ~ ANY)* ~ "\"" }
number = @{ "-"? ~ ("0" | ASCII_NONZERO_DIGIT ~ ASCII_DIGIT*) ~ ("." ~ ASCII_DIGIT*)? }
boolean = { "true" | "false" }
null = { "null" }

// Multiline block scalar (YAML-style "|")
// Captures indented lines after "|". Empty lines are preserved.
// Block continues as long as lines are indented or blank.
// A blank line is only consumed if followed by another indented line (lookahead prevents over-consuming).
multiline_marker = _{ "|" }
multiline_line = @{ " "+ ~ (!NEWLINE ~ ANY)* }
multiline_sep = _{ NEWLINE ~ &(NEWLINE | " ") }
multiline_string = ${ multiline_marker ~ (multiline_sep ~ multiline_line?)+ }

list_item = { string }
list = { "[" ~ (list_item ~ ("," ~ list_item)*)? ~ ","? ~ "]" }

// JSON 支持
json_pair = { string ~ ":" ~ json_value }
json_object = { "{" ~ (json_pair ~ ("," ~ json_pair)*)? ~ ","? ~ "}" }
json_array = { "[" ~ (json_value ~ ("," ~ json_value)*)? ~ ","? ~ "]" }
json_value = { json_object | json_array | string | number | boolean | null }

// Fields
key_slug = { "slug" ~ ":" ~ string }
key_name = { "name" ~ ":" ~ string }
key_desc = { "description" ~ ":" ~ string }
key_model = { "model" ~ ":" ~ string }
key_temp = { "temperature" ~ ":" ~ number }
key_mcp = { "mcp" ~ ":" ~ list }
key_skills = { "skills" ~ ":" ~ list }
// 【新增】关联工作流文件
key_workflow = { "workflow" ~ ":" ~ string }
// 【新增】默认 tools 配置（支持 JSON 数组、字符串引用、或字符串数组引用）
key_tools = { "tools" ~ ":" ~ (json_array | list | string) }

// System Prompt can be a string, p(slug="..."), or multiline block scalar
p_func = { "p" ~ "(" ~ "slug" ~ "=" ~ string ~ ")" }
key_system = { "system_prompt" ~ ":" ~ (multiline_string | string | p_func) }

// Agent Definition
agent_def = {
    SOI ~
    (key_slug | key_name | key_desc | key_model | key_temp | key_mcp | key_skills | key_system | key_workflow | key_tools)+
    ~ EOI
}